<?xml version="1.0" encoding="UTF-8"?>

<!-- Standard username/password database -->
<meta:Type
  xmlns:meta="class:/spiralcraft/data/types/meta"
  xmlns:security="class:/spiralcraft/security"
  xmlns:codec="class:/spiralcraft/codec/text/"
  xmlns:sec="class:/spiralcraft/security/"
  xmlns:secauth="class:/spiralcraft/security/auth/"
  >
  
  <fields>
  
    <!--  Login.principalId -->
    <meta:SequenceField>
      
      <name>principalId
      </name>
      
      <type>
        <String.type>

          <maxLength>64
          </maxLength>
        
        </String.type>
      </type>

    </meta:SequenceField>

    <!--  Login.username -->
    <meta:Field>
      
      <name>username
      </name>
      
      <type>
        <String.type>

          <maxLength>64
          </maxLength>
        
        </String.type>
      </type>

    </meta:Field>

    <!--  Login.searchname -->
    <meta:CalculatedField>

      <name>searchname
      </name>

      <transient>false
      </transient>
      
      <expression>username.toLowerCase()
      </expression>
        
      <type>
        <String.type>

          <maxLength>64
          </maxLength>
        
        </String.type>
      </type>

    </meta:CalculatedField>
    
    <!--  Login.clearpass -->
    <meta:Field>

      <name>clearpass
      </name>

      <type>
        <String.type>

          <maxLength>64
          </maxLength>
        
        </String.type>
      </type>

    </meta:Field>
       
    <!--  Login.digestpass -->
    <meta:Field>

      <name>digestpass
      </name>

      <description>hex encoded password digest
      </description>

      <type>
        <String.type>

          <maxLength>512
          </maxLength>
        
        </String.type>
      </type>

    </meta:Field>
    
    
  </fields>
  
  <keys>
    <meta:Key>
      <primary>true
      </primary>
      
      <fieldList>principalId
      </fieldList>
    
    </meta:Key>

    <meta:Key>
      <unique>true
      </unique>

      <fieldList>searchname
      </fieldList>
    </meta:Key>
    
      
  </keys>

  <methods>
    <meta:Method>
      <name>securePassword
      </name>
      
      <parameterTypes>
        <secauth:DigestFunction.type/>
      </parameterTypes>
      
      <returnType><Void.type/>
      </returnType>
      
      <contextX>
        { 
          digestFunction:[@secauth:DigestFunction]
        }
      </contextX>
      
      <x>
        @{[sec:Login].digestpass
            =[@codec:HexCodec].@encodeHex
              (digestFunction.digest([sec:Login]{.searchname+.clearpass})
              )
          ,[sec:Login].clearpass=null
        }
      </x>
    </meta:Method>
  </methods>
</meta:Type>
